<html>
    <head>
        <title>Devoxx - Leaflet</title>
        <meta http-equiv="Content-Type"content="text/html; charset=utf-8">
        <link rel="shortcut icon" href="https://devoxx.be/wp-content/uploads/2016/04/favicon.ico" type="image/x-icon">
        <style>
            body {
                width: 100%;
                height: 80vh;
                margin: 0;
            }
            h1 {
                text-align: center;
            }
            #map {
                width: 100%;
                height: 100%;
            }
            .devoxx-popup-container {
                width: 200px;
                font-size: 21px;
            }
            .devoxx-popup-container .leaflet-popup-content-wrapper, .devoxx-popup-container .leaflet-popup-tip {
                background-color: black;
                color: white
            }
            .info {
                padding: 6px 8px;
                font: 14px/16px Arial, Helvetica, sans-serif;
                background: white;
                background: rgba(255,255,255,0.8);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-radius: 5px;
            }
            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }
            .legend {
                line-height: 18px;
                color: #555;
                padding: 10px;
                padding-top: 5px;
            }
            .legend i {
                width: 18px;
                height: 18px;
                float: left;
                margin-right: 8px;
                opacity: 0.7;
            }

        </style>
        <script src="data.js"></script>
        <script src="isochrones.js"></script>
        <script src="journey.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
            integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
            crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>
        <script type="text/javascript">

            var colors = [
                //"#D5DDF1",
                //"#BCCBE0",
                //"#6F798E",
                //"#34607C",
                "#85c1e9",
                "#5dade2",
                "#3498db",
                "#2e86c1",
                "#2874a6",
                "#21618c",
                "#1b4f72"
            ]

            var gradientColors = [
                "#F9F871",
                "#B9F68D",
                "#83EDAF",
                "#5FDFCA",
                "#60CED6",
                "#79BBD2"
            ]

            var matchingGradient = [
                "#79BBD2",
                "#71A6CE",
                "#788FC2",
                "#8676AD",
                "#925C8E",
                "#944367",
            ]


            function barsLayer() {
                var barLayerGroup = bars.map(bar => {
                    return L.marker(
                        [bar.geometry.location.lat,bar.geometry.location.lng],
                        {
                            title: bar.name
                        }
                    ).bindPopup(bar.name);
                })
                return L.layerGroup(barLayerGroup);
            }

            function isochronesLayer() {
                var isochronesLayerGroup = isochrones.isochrones.map((iso, idx) => {
                    const color = matchingGradient[idx];
                    return L.geoJSON(iso.geojson, {
                        style: {
                            fillColor: color,
                            weight: 1,
                            opacity: 0.9,
                            color: color,
                            fillOpacity: 0.8,
                        }, attribution: '&copy; Navitia'
                    });
                })
                return L.layerGroup(isochronesLayerGroup);
            }

            function toMin(durationInSec) {
                return Math.round((durationInSec / 60)) + 'min.'
            }

            function legend() {
                var legend = L.control({position: 'bottomright'});

                legend.onAdd = function (map) {

                    var div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML = '<h4>Travel time legend</h4>'

                    isochrones.isochrones.forEach((iso, idx, allTab) => {
                        var text = toMin(iso.min_duration) + '&dash;' + toMin(iso.max_duration)
                        div.innerHTML +=
                        '<i style="background:' + matchingGradient[idx] + '"></i> ' +
                            text + (idx !== allTab.length - 1 ? '<br>' : '');
                    })
                    return div;
                };

                return legend;
            }

            function journeyLine() {
                var multiLines = journey.journeys.map(j => {
                    
                    var latlngs = j.sections.map(s => {
                        return s.geojson.coordinates.map(coord => {
                            return [coord[1], coord[0]]
                        })
                    })
                    var line = L.polyline(latlngs, {color: 'yellow', weight: 12, attribution: '&copy; Navitia'}).bindPopup('Duration : ~' + toMin(j.duration));
                    line.on('mouseover', function () {
                        line.setStyle({color: 'red'})
                    })
                    line.on('mouseout', function () {
                        line.setStyle({color: 'yellow'})
                    })
                    return line
                })
                return L.layerGroup(multiLines);
            }

            function init(){
                // Kinepolis
                var lat = 51.2459082;
                var lng = 4.4162091;


                // Station Antwerpen Centraal
                var stationLat = 51.217222;
                var stationLng = 4.421111;

                var zoomLevel = 13;
                var map = L.map('map').setView([lat, lng], zoomLevel);
                var stationMarker = L.marker(
                    [stationLat, stationLng],
                    {
                        title: "Antwerpen Centraal"
                    }
                );

                var journeyOverlay = journeyLine();
                //journeyOverlay.addTo(map);

                var stationJourneyLayer = L.layerGroup([journeyOverlay, stationMarker])
                //stationMarker.addTo(map);
                // z => niveau de zoom
                // x,y => coordonnées du tiles
                // r => retina

                /*
                Tiles are numbered as {z}/{x}/{y}, where z is zoom, x is the tile number from left to right, and y is the tile number from top to bottom.
                */

                // OpenStreetMap
                var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                });
                var mainLayer = L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
                    attribution: '<a href="https://wikimediafoundation.org/wiki/Maps_Terms_of_Use">Wikimedia</a>',
                    minZoom: 1,
                    maxZoom: 19
                });
                var stamenToner = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                    attribution: 'Map tiles by Stamen Design, CC BY 3.0 — Map data © OpenStreetMap',
                    subdomains: 'abcd',
                    minZoom: 0,
                    maxZoom: 20,
                    ext: 'png'
                });
                var OpenRailwayMap = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> | Map style: &copy; <a href="https://www.OpenRailwayMap.org">OpenRailwayMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                });
                var grayScaleLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    id: 'mapbox.light',
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>'
                })
                //var transportAntwerpen = 'https://b.tile.thunderforest.com/transport/13/4198/2733.png?apikey=6170aad10dfd42a38d4d8c709a536f38'
                var transportAntwerpen = L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', {
                    attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    apikey: '6170aad10dfd42a38d4d8c709a536f38',
                    maxZoom: 22
                });
                var transportLayer = L.tileLayer('http://openptmap.org/tiles/{z}/{x}/{y}.png',
                {
                    attribution: '&copy; <a href="http://openptmap.org/" target="_blank" rel="noopener noreferrer">OpenPTMap</a> / <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OSM Contributors</a>',
                    maxZoom: 22,
                })

                var barsOverlay = barsLayer()

                var isochronesOverlay = isochronesLayer();                
                var legendControl = legend()
                isochronesOverlay.on('add', function() {
                    legendControl.addTo(map);
                });
                isochronesOverlay.on('remove', function() {
                    legendControl.remove();
                });


                var controlLayer = L.control.layers({
                    'OpenStreetMap': osmLayer,
                    'Wikimedia': mainLayer,
                    'Stamen': stamenToner,
                    'GrayScale': grayScaleLayer
                }, {
                    'Travel time': isochronesOverlay,
                    'Transport': transportLayer,
                    'Bars': barsOverlay,
                    'Station': stationJourneyLayer,
                })
                map.addLayer(mainLayer);
                controlLayer.addTo(map);
                var customIcon = L.icon({
                    iconUrl: 'devoxxMarker.png',
                    //shadowUrl: 'icon-shadow.png',
                    iconSize:     [64, 64], // taille de l'icone
                    //shadowSize:   [50, 64], // taille de l'ombre
                    iconAnchor:   [32, 64], // point de l'icone qui correspondra à la position du marker
                    //shadowAnchor: [32, 64],  // idem pour l'ombre
                    popupAnchor:  [0, -64] // point depuis lequel la popup doit s'ouvrir relativement à l'iconAnchor
                });
                var devoxxMarker = L.marker(
                    [lat, lng],
                    {icon: customIcon}
                );
                var center = L.marker(
                    [lat, lng],
                );
                devoxxMarker.bindPopup("<div class='devoxx-popup'>Devoxx is here ! <br><img src='DevoxxLogo.png'></div>", {className: 'devoxx-popup-container'})
                devoxxMarker.bindTooltip("<span>Devoxx Location (Kinepolis)</span>")
                devoxxMarker.addTo(map);
            }
        </script>
    </head>
    <body onload="init()">
        <h1>Leaflet - Playground</h1>
    <div id="map"></div>
    </body>
</html>